<?php

function jobbag_schema() {

  $schema['jobbag'] = array(
    'description' => st('Job Bag Entities'),
    'fields' => array(
      'jid' => array(
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'type' => array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => TRUE
      ),
      'uid' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'title' => array(
        'type' => 'text',
        'size' => 'normal',
        'not null' => TRUE
      ),
      'status' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 1
      ),
      'created' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'changed' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'closed' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'description' => st('The date the job was closed'),
        'initial' => 0
      ),
      'cancelled' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'description' => st('The date the job was cancelled'),
        'initial' => 0
      ),
      'data' => array(
        'type' => 'text',
        'size' => 'medium',
        'serialize' => TRUE,
        'not null' => FALSE
      )
    ),
    'foreign keys' => array(
      'type' => array(
        'table' => 'jobbag_type',
        'type' => 'type'
      ),
      'client_id' => array(
        'table' => 'jobbag_client',
        'client_id' => 'cid'
      )
    ),
    'primary key' => array('jid')
   );

  $schema['jobbag_type'] = array(
    'description' => st('The types of jobs for use with {jobbag}'),
    'fields' => array(
      'id' => array(
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'type' => array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => TRUE
      ),
      'label' => array(
        'type' => 'varchar',
        'length' => 50,
        'not null' => TRUE
      ),
      'status' => array(
        'type' => 'int',
        'not null' => TRUE,
        // Set the default to ENTITY_CUSTOM without using the constant as it is
        // not safe to use it at this point.
        'default' => 0x01,
        'size' => 'tiny',
        'description' => st('The exportable status of the entity.'),
      ),
      'module' => array(
        'description' => st('The name of the providing module if the entity has been defined in code.'),
        'type' => 'varchar',
        'length' => 255,
        'not null' => FALSE,
      ),
      'weight' => array(
        'type' => 'int',
        'unsigned' => FALSE,
        'not null' => TRUE,
        'default' => 0
      )
    ),
    'unique keys' => array('type' => array('type')),
    'primary key' => array('id')
  );

  $schema['jobbag_client'] = array(
    'description' => st('An id to build a relationship between the job and the client'),
    'fields' => array(
      'cid' => array(
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'prefix' => array(
        'type' => 'varchar',
        'length' => 5,
        'not null' => TRUE
      ),
      'label' => array(
        'type' => 'varchar',
        'length' => 50,
        'not null' => TRUE
      ),
      'sequence' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0
      ),
      'created' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'changed' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE
      ),
      'status' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0x01,
        'size' => 'tiny'
      ),
      'module' => array(
        'description' => st('The name of the providing module if the entity has been defined in code.'),
        'type' => 'varchar',
        'length' => 255,
        'not null' => FALSE,
      ),
    ),
    'primary key' => array('cid'),
    'unique keys' => array('prefix' => array('prefix'), 'prefix_sequence' => array('prefix', 'sequence'))
  );

  return $schema;
}

function jobbag_install() {
  $batch = array(
    'title' => st('Installing Job Fields and Instances'),
    'init_message' => st('Field installation starting...'),
    'operations' => array(
      array('_jobbag_create_default_fields', array()),
      array('_jobbag_create_default_instances', array()),
      array('_jobbag_create_default_type', array())
    ),
    'finished' => '_jobbag_create_batch_finish',
    'file' => drupal_get_path('module', 'jobbag') . '/jobbag.install',
  );
  batch_set($batch);
}

function _jobbag_create_default_type(&$context) {
  $default = array();

  $default['type'] = 'default';
  $default['label'] = st('Basic Job');
  $default['status'] = ENTITY_IN_CODE;
  $default['module'] = 'jobbag';
  $default['weight'] = 0;

  $entity = entity_create('job_type', $default);
  entity_save('job_type', $entity);
  $context['results'][] = st('Created job type: %type', array('%type' => $entity->label()));
}

function _jobbag_create_default_fields(&$context) {
  $fields = array();
  $fields['client_field'] = array(
    'field_name' => 'job_client_id',
    'module' => 'jobbag',
    'type' => 'entityreference',
    'cardinality' =>  1,
    'settings' => array(
      'target_type' => 'job_client',
      'handler_settings' => array(
        'sort' => array(
          'type' => 'property',
          'property' => 'label',
          'direction' => 'ASC'
        )
      )
    )
  );

  $fields['job_ref_field'] = array(
    'field_name' => 'job_reference',
    'module' => 'jobbag',
    'type' => 'entityreference',
    'cardinality' =>  -1,
    'required' => FALSE,
    'settings' => array(
      'target_type' => 'job',
      'handler_settings' => array(
        'sort' => array(
          'type' => 'property',
          'property' => 'title'
        )
      )
    )
  );

  $fields['date_field'] = array(
    'field_name' => 'job_due_date',
    'module' => 'jobbag',
    'type' => 'date',
    'cardinality' =>  1,
    'settings' => array(
      'granularity' => drupal_map_assoc(array('year', 'month', 'day'))
    )
  );

  $fields['desc_field'] = array(
    'field_name' => 'job_description',
    'module' => 'jobbag',
    'type' => 'text_with_summary',
    'cardinality' =>  1,
    'settings' => array(),
  );

  foreach($fields as $name => $field) {
    field_create_field($field);
    $context['results'][] = st('Field %name created...', array('%name' => $name));
  }

}

function _jobbag_create_default_instances(&$content) {
  $instances = array();

  $instances['client_instance'] = array(
    'field_name' => 'job_client_id',
    'entity_type' => 'job',
    'bundle' => 'default',
    'label' => t('Client'),
    'required' => TRUE,
    'settings' => array(),
    'widget' => array('type' => 'options_select', 'weight' => -10),
    'display' => array(
      'default' => array(
        'type' => 'entityreference_label',
        'settings' => array(
          'link' => 1
        ),
        'weight' => 1
      ),
      'teaser' => array(
        'type' => 'entityreference_label',
        'settings' => array(
          'link' => 0
        ),
        'weight' => 1
      )
    )
  );

  $instances['job_ref_instance'] = array(
    'field_name' => 'job_reference',
    'entity_type' => 'job',
    'bundle' => 'default',
    'label' => t('Job Reference'),
    'settings' => array(),
    'widget' => array('type' => 'entityreference_autocomplete_tags', 'weight' => -9),
    'display' => array(
      'default' => array(
        'type' => 'entityreference_label',
        'settings' => array(
          'link' => 1
        ),
        'weight' => 2
      ),
      'teaser' => array(
        'type' => 'hidden',
        'weight' => 2
      )
    ),
  );

  $instances['date_instance'] = array(
    'field_name' => 'job_due_date',
    'entity_type' => 'job',
    'bundle' => 'default',
    'label' => t('Date Due'),
    'settings' => array(),
    'widget' => array('type' => module_exists('date_popup') ? 'date_popup' : 'date_text', 'weight' => -8),
    'display' => array(
      'default' => array(
        'weight' => 3
      ),
      'teaser' => array(
        'type' => 'hidden',
        'weight' => 3
      )
    ),
  );

  $instances['desc_instance'] = array(
    'field_name' => 'job_description',
    'entity_type' => 'job',
    'bundle' => 'default',
    'label' => t('Description'),
    'settings' => array(),
    'widget' => array('type' => 'text_textarea_with_summary', 'weight' => -7),
    'display' => array(
      'default' => array(
        'type' => 'text_default',
        'weight' => 4
      ),
      'teaser' => array(
        'type' => 'text_summary_or_trimmed',
        'settings' => array(
          'trim_length' => 600
        ),
        'weight' => 4
      )
    ),
  );

  foreach ($instances as $name => $instance) {
    field_create_instance($instance);
    $context['results'][] = st('Instance %name created...', array('%name' => $name));
  }
}

function _jobbag_create_batch_finish($success, $results, $operations) {
  if ($success) {
    $message = t('Field and instance installation succeeded...');
  }
  else {
    $error_operation = reset($operations);
    $message = 'An error occurred while processing ' . $error_operation[0] . ' with arguments :'
      . print_r($error_operation[0], TRUE);
  }
  drupal_set_message($message);
}

function jobbag_uninstall() {
  module_load_include('module', 'jobbag');
  db_delete('search_dataset')->condition('type', 'job')->execute();
  db_delete('search_index')->condition('type', 'job')->execute();

    if($instance = field_read_instance('job', 'job_client_id', 'default'))
      field_delete_instance($instance, FALSE);
    field_delete_field('job_client_id');
    if($instance = field_read_instance('job', 'job_description', 'default'))
      field_delete_instance($instance, FALSE);
    field_delete_field('job_description');
    if($instance = field_read_instance('job', 'job_reference', 'default'))
      field_delete_instance($instance, FALSE);
    field_delete_field('job_reference');
    if($instance = field_read_instance('job', 'job_due_date', 'default'))
      field_delete_instance($instance, FALSE);
    field_delete_field('job_due_date');

  field_purge_batch(100);
}